{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/jira/UMS/apps/web/lib/two-factor.ts"],"sourcesContent":["\"use server\";\n\nimport speakeasy from \"speakeasy\";\nimport QRCode from \"qrcode\";\nimport { prisma } from \"@ums/lib\";\nimport crypto from \"crypto\";\n\n/**\n * Generate 2FA secret for a user\n */\nexport async function generate2FASecret(userId: string, email: string) {\n    const secret = speakeasy.generateSecret({\n        name: `UMS (${email})`,\n        issuer: \"University Management System\",\n        length: 32,\n    });\n\n    // Generate QR code\n    const qrCodeUrl = await QRCode.toDataURL(secret.otpauth_url!);\n\n    return {\n        secret: secret.base32,\n        qrCode: qrCodeUrl,\n        otpauthUrl: secret.otpauth_url,\n    };\n}\n\n/**\n * Verify 2FA token\n */\nexport async function verify2FAToken(secret: string, token: string): Promise<boolean> {\n    return speakeasy.totp.verify({\n        secret,\n        encoding: \"base32\",\n        token,\n        window: 2, // Allow 2 time steps before/after for clock skew\n    });\n}\n\n/**\n * Enable 2FA for a user\n */\nexport async function enable2FA(userId: string, secret: string, token: string) {\n    // Verify the token first\n    const isValid = await verify2FAToken(secret, token);\n\n    if (!isValid) {\n        throw new Error(\"Invalid verification code\");\n    }\n\n    // Generate backup codes\n    const backupCodes = generateBackupCodes();\n\n    // Save to database\n    await prisma.user.update({\n        where: { id: userId },\n        data: {\n            twoFactorSecret: secret,\n            twoFactorEnabled: true,\n            twoFactorBackupCodes: JSON.stringify(backupCodes),\n        },\n    });\n\n    return backupCodes;\n}\n\n/**\n * Disable 2FA for a user\n */\nexport async function disable2FA(userId: string, password: string) {\n    const bcrypt = require(\"bcryptjs\");\n\n    // Verify password first\n    const user = await prisma.user.findUnique({\n        where: { id: userId },\n    });\n\n    if (!user) {\n        throw new Error(\"User not found\");\n    }\n\n    const isValidPassword = await bcrypt.compare(password, user.passwordHash);\n\n    if (!isValidPassword) {\n        throw new Error(\"Invalid password\");\n    }\n\n    // Disable 2FA\n    await prisma.user.update({\n        where: { id: userId },\n        data: {\n            twoFactorSecret: null,\n            twoFactorEnabled: false,\n            twoFactorBackupCodes: null,\n        },\n    });\n}\n\n/**\n * Verify 2FA code (including backup codes)\n */\nexport async function verify2FACode(userId: string, code: string): Promise<boolean> {\n    const user = await prisma.user.findUnique({\n        where: { id: userId },\n        select: {\n            twoFactorSecret: true,\n            twoFactorBackupCodes: true,\n        },\n    });\n\n    if (!user || !user.twoFactorSecret) {\n        return false;\n    }\n\n    // Try TOTP first\n    const isValidTotp = await verify2FAToken(user.twoFactorSecret, code);\n\n    if (isValidTotp) {\n        return true;\n    }\n\n    // Try backup codes\n    if (user.twoFactorBackupCodes) {\n        const backupCodes: string[] = JSON.parse(user.twoFactorBackupCodes);\n        const codeIndex = backupCodes.indexOf(code);\n\n        if (codeIndex !== -1) {\n            // Remove used backup code\n            backupCodes.splice(codeIndex, 1);\n\n            await prisma.user.update({\n                where: { id: userId },\n                data: {\n                    twoFactorBackupCodes: JSON.stringify(backupCodes),\n                },\n            });\n\n            return true;\n        }\n    }\n\n    return false;\n}\n\n/**\n * Generate backup codes\n */\nfunction generateBackupCodes(count: number = 10): string[] {\n    const codes: string[] = [];\n\n    for (let i = 0; i < count; i++) {\n        const code = crypto.randomBytes(4).toString(\"hex\").toUpperCase();\n        codes.push(code);\n    }\n\n    return codes;\n}\n\n/**\n * Check if user has 2FA enabled\n */\nexport async function is2FAEnabled(userId: string): Promise<boolean> {\n    const user = await prisma.user.findUnique({\n        where: { id: userId },\n        select: { twoFactorEnabled: true },\n    });\n\n    return user?.twoFactorEnabled || false;\n}\n"],"names":[],"mappings":"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"}}]
}